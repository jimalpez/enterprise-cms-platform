---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleCard from '../../components/astro/ArticleCard.astro';
import SearchBar from '../../components/islands/SearchBar';
import { contentApi } from '../../lib/api';

const { searchParams } = Astro.url;
const page = parseInt(searchParams.get('page') || '1');
const limit = 9;

// Fetch articles
let articles = [];
let total = 0;
let totalPages = 0;

try {
  const response = await contentApi.getAll({ 
    page, 
    limit,
    status: 'published'
  });
  articles = response.items;
  total = response.total;
  totalPages = response.totalPages;
} catch (error) {
  console.error('Error fetching articles:', error);
}

const prevPage = page > 1 ? page - 1 : null;
const nextPage = page < totalPages ? page + 1 : null;
---

<BaseLayout title="Blog">
  <div class="container mx-auto px-4 py-12">
    <!-- Header -->
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold mb-4">Blog</h1>
      <p class="text-xl text-gray-600 mb-8">
        Explore our latest articles and insights
      </p>
      <div class="flex justify-center">
        <SearchBar client:load />
      </div>
    </div>

    <!-- Articles Grid -->
    {articles.length > 0 ? (
      <>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
          {articles.map((article) => (
            <ArticleCard article={article} />
          ))}
        </div>

        <!-- Pagination -->
        {totalPages > 1 && (
          <div class="flex justify-center items-center gap-4">
            {prevPage && (
              <a 
                href={`/blog?page=${prevPage}`}
                class="btn btn-secondary"
              >
                ← Previous
              </a>
            )}
            
            <span class="text-gray-600">
              Page {page} of {totalPages}
            </span>
            
            {nextPage && (
              <a 
                href={`/blog?page=${nextPage}`}
                class="btn btn-secondary"
              >
                Next →
              </a>
            )}
          </div>
        )}
      </>
    ) : (
      <div class="text-center py-12">
        <p class="text-gray-500 text-lg">No articles found.</p>
      </div>
    )}
  </div>
</BaseLayout>